<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/favicon.png"  />
    <title>Consignes TP - Github actions</title>
    <link
      rel="stylesheet"
      href="https://danyellow.net/cours-mmi/consignes.css"
    />
    <script src="https://danyellow.net/cours-mmi/scripts.js" defer></script>
  </head>

  <body>
    <header class="entete-consignes">
      <h1 class="h1">Consignes de la pratique - Github actions</h1>
      <details class="consignes-conteneur">
         <summary>
          <h1 class="h1">Structure d'un fichier de configuration (cliquer pour afficher / cacher)</h1>
        </summary>
        <pre style="font-family:monospace;color: rgb(197, 200, 198); background-color: rgb(29, 31, 33); font-weight: 400; padding: 1rem; border-radius: 0.5rem;"><span style="color: rgb(197, 200, 198); font-weight: 400;">name:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">My</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">workflow</span> <span style="color: rgb(112, 120, 128); font-weight: 400;"># Facultatif. Affich√© dans l'onglet "Actions" du d√©p√¥t</span>
<span style="color: rgb(197, 200, 198); font-weight: 400;">on:</span> [<span style="color: rgb(181, 189, 104); font-weight: 400;">push</span>] <span style="color: rgb(112, 120, 128); font-weight: 400;"># Obligatoire, permet de d√©finir pour quelles actions se lance le pipeline</span>
<span style="color: rgb(197, 200, 198); font-weight: 400;">jobs:</span>
  <span style="color: rgb(197, 200, 198); font-weight: 400;">my_first_job:</span> <span style="color: rgb(112, 120, 128); font-weight: 400;"># Obligatoire, job_id. Doit commencer par une lettre et ne doit pas contenir d'espace</span>
    <span style="color: rgb(197, 200, 198); font-weight: 400;">name:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">My</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">first</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">job</span> <span style="color: rgb(112, 120, 128); font-weight: 400;"># Facultatif, nom du job, remplace le job_id si pr√©sent dans la pipeline</span>
    <span style="color: rgb(197, 200, 198); font-weight: 400;">runs-on:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">ubuntu-latest</span> <span style="color: rgb(112, 120, 128); font-weight: 400;"># D√©finit le type de machine √† utiliser</span>
    <span style="color: rgb(197, 200, 198); font-weight: 400;">steps:</span> <span style="color: rgb(112, 120, 128); font-weight: 400;"># Contient la liste des t√¢ches du job</span>
      <span style="color: rgb(129, 162, 190); font-weight: 400;">-</span> <span style="color: rgb(197, 200, 198); font-weight: 400;">name:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">Say</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">hello</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">to</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">me</span> <span style="color: rgb(112, 120, 128); font-weight: 400;"># Facultatif, nom de la t√¢che</span>
        <span style="color: rgb(197, 200, 198); font-weight: 400;">run:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">echo</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">"Hello $<span style="color: rgb(138, 190, 183); font-weight: 400;">{{ github.actor }}</span> ! ü•≥"</span> <span style="color: rgb(112, 120, 128); font-weight: 400;"># Obligatoire, t√¢che √† effectuer</span>
      <span style="color: rgb(129, 162, 190); font-weight: 400;">-</span> <span style="color: rgb(197, 200, 198); font-weight: 400;">name:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">List</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">files</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">in</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">the</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">repository</span>
        <span style="color: rgb(197, 200, 198); font-weight: 400;">run:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">|</span> <span style="color: rgb(112, 120, 128); font-weight: 400;"># Le pipe (|) permet d'√©crire du texte multilignes</span>
          <span style="color: rgb(181, 189, 104); font-weight: 400;">ls</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">${{</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">github.workspace</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">}}</span></pre>
        <ul>
          <li>
            <a href="https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/accessing-contextual-information-about-workflow-runs#github-context" target="_blank">Voir l'ensemble des cl√©s d'un fichier de configuration - ouveture dans un nouvel onglet</a>
          </li>
        </ul>
      </details>
      <details class="consignes-conteneur" open>
        <summary>
          <h1 class="h1">Partie 1 (cliquer pour afficher / cacher)</h1>
        </summary>
        <ol class="liste-consignes">
          <li>Cr√©ez un d√©p√¥t sur votre compte Github</li>
          <li>
            A l'aide du didacticiel sur les Github Actions. Ajoutez l'action en
            exemple dans votre projet
            <ul>
              <li>
                <a
                  href="https://docs.github.com/fr/actions/writing-workflows/quickstart"
                  target="_blank"
                  rel="noopener noreferrer"
                  >Didacticiel sur les Github Actions - Ouverture dans un nouvel
                  onglet</a
                >
              </li>
            </ul>
          </li>
          <li>
            Ajoutez une commande Linux de votre choix √† votre fichier d'Actions et observez le r√©sultat dans GitHub 
            <p class="note-information">
              N'oubliez pas de commiter et pusher vos modifications, sinon, vous
              ne verrez pas vos mises √† jour.
            </p>
          </li>
        </ol>
        <p class="note-information">
          Vos actions sont ex√©cut√©es dans l'onglet "Actions" de votre d√©p√¥t.
          √âgalement accessible via l'URL :
          https://github.com/votre-pseudo/nom-du-depot/actions
        </p>
        <div class="note-information">
            <p>Si vous le souhaitez, vous pouvez installer l'extension gratuite de VS Code : GitHub Actions. En plus de proposer l'autocompl√©tion de vos  fichiers de workflows, elle vous permet d'avoir une vue d'ensemble sur vos workflows depuis VS Code (√† condition de lier votre compte Github)</p>
            <ul>
                <li>
                    <a href="https://marketplace.visualstudio.com/items?itemName=GitHub.vscode-github-actions" target="_blank" rel="noopener noreferrer">T√©l√©charger l'extension GitHub Actions pour VS Code</a>
                </li>
            </ul>
        </div>
      </details>
      <details class="consignes-conteneur">
        <summary>
          <h1 class="h1">Partie 2 (cliquer pour afficher / cacher)</h1>
        </summary>
        <ol class="liste-consignes">
          <li>
            Remplacez le contenu du d√©p√¥t cr√©e pr√©c√©demment par un projet npm
            (commande <code>npm init --y</code>).
          </li>
          <li>
            Installez les d√©pendances suivantes :
            <ul>
              <li>
                <a
                  href="https://www.npmjs.com/package/release-it"
                  target="_blank"
                  rel="noopener noreferrer"
                  >release-it - Ouverture dans un nouvel onglet</a
                >.
                <p>
                  Pensez √† s√©lectionner ".release-it.json" lors de
                  l'installation avec la commande
                  <code>npm init release-it</code>, sinon cr√©ez vous-m√™me le
                  fichier.
                </p>
              </li>
              <li>
                <a
                  href="https://www.npmjs.com/package/@release-it/conventional-changelog"
                  target="_blank"
                  rel="noopener noreferrer"
                  >@release-it/conventional-changelog - Ouverture dans un nouvel
                  onglet</a
                >
              </li>
            </ul>
            <div class="note-information">
              <p>
                N'oubliez pas de mettre un fichier .gitignore √† la racine de
                votre projet. Les node_modules (ou tout autre fichier de
                d√©pendances) n'ont rien √† faire sur votre d√©p√¥t.
              </p>
              <p>
                Si vous n'√™tes pas √† l'aise avec ce genre de fichiers, il en
                existe d√©j√† fait dans un d√©p√¥t d√©di√©. Dans le cas de notre
                projet, prenez celui de Node.
              </p>
              <ul>
                <li>
                  <a
                    href="https://github.com/github/gitignore"
                    target="_blank"
                    rel="noopener noreferrer"
                    >Acc√©der √† la liste de gitignore - Ouverture dans un nouvel
                    onglet</a
                  >
                </li>
              </ul>
            </div>
            <p class="note-attention">
              Le module "release-it" a √©t√© pens√© pour d√©ployer sur npm. Nous
              n'avons pas besoin de cette fonctionnalit√© et si nos identifiants
              npm ne sont pas d√©finis, vous serez bloqu√©(e). Pour √©viter tout
              bloquage, il faudra pr√©ciser au module qu'on souhaite juste
              deployer sur git. De ce fait, vous devrez avoir la cl√©
              "npm.publish" (c'est une imbrication de cl√©s) avec la valeur
              "false" dans le fichier .release-it.json.
            </p>
          </li>
          <li>
            Testez la t√¢che de release depuis la ligne de commandes, elle a √©t√©
            ajout√©e dans votre fichier package.json.
            <div class="note-information">
              <p>
                Gr√¢ce au module "@release-it/conventional-changelog", vous allez
                pouvoir g√©n√©rer un fichier CHANGELOG.md, ce fichier permet de
                traquer toutes les releases que vous avez fait, version par
                version en indiquant le d√©tail de commits. Toutefois pour
                g√©n√©rer correctement ce fichier, il faut respecter un certain
                formattage qui permettra au module release-it de savoir quel est
                le prochain num√©ro de version (major, minor, patch).
              </p>
              <ul>
                <li>
                  <a
                    href="https://github.com/angular/angular/blob/main/CONTRIBUTING.md#type"
                    >Acc√©der au formattage de commit selon Angular</a
                  >
                </li>
              </ul>
              <p>
                Mais pour faire simple, si votre commit commence par "feat:",
                ceci incr√©mentera le num√©ro de minor : X.MINOR.X. Si votre
                commit commence par "fix:", ceci incr√©mentera le num√©ro de patch
                : X.X.PATCH. Il est bien √©videmment possible d'avoir plusieurs
                commits commen√ßant par "feat:" ou "fix:" au sein de la m√™me
                version. M√™me si vous avez plusieurs "feat" ou "fix" dans vos commits, votre num√©ro de version n'incr√©mentera qu'une seule fois.
              </p>
              <p>
                C'est pour cette raison qu'il est important de s√©parer ses
                commits par fonctionnalit√© et les nommer clairement. Gr√¢ce √† ce syst√®me, vous pouvez voir
                en un coup d'oeil la liste des fonctionnalit√©s / bugs corrig√©s
                version par version.
              </p>
              <p>A noter qu'en absence de nouveaux commits avec la bonne nomenclature, seul le num√©ro de PATCH sera incr√©ment√©.</p>
            </div>
          </li>
          <li>
            Ajoutez un nouveau job ou un nouveau fichier d'Actions pour
            effectuer une release de votre projet. Pour ce faire voici les
            actions que vous devez avoir dans votre fichier YAML :
            <ol>
              <li>
                Cloner le projet : <code>actions/checkout@v4</code>. C'est une
                action pr√©d√©finie, il faudra utiliser la cl√© "uses" √† la place
                de "run"
                <ul>
                    <li>
                        <a href="https://github.com/sdras/awesome-actions?tab=readme-ov-file#official-actions" target="_blank" rel="noopener noreferrer">Voir curation de Github Actions - Ouverture dans un nouvel onglet</a>
                    </li>
                </ul>
                <p>Exemple : </p>
                <pre style="font-family:monospace;color: rgb(197, 200, 198); background-color: rgb(29, 31, 33); font-weight: 400; padding: 1rem; border-radius: 0.5rem;"><span style="color: rgb(197, 200, 198); font-weight: 400;">jobs:</span>
  <span style="color: rgb(197, 200, 198); font-weight: 400;">build:</span>
    <span style="color: rgb(197, 200, 198); font-weight: 400;">name:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">Build</span>
    <span style="color: rgb(197, 200, 198); font-weight: 400;">runs-on:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">ubuntu-latest</span>
    <span style="color: rgb(197, 200, 198); font-weight: 400;">steps:</span>
      <span style="color: rgb(129, 162, 190); font-weight: 400;">-</span> <span style="color: rgb(197, 200, 198); font-weight: 400;">name:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">Check</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">out</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">repository</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">code</span>
        <span style="color: rgb(197, 200, 198); font-weight: 400;">uses:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">actions/checkout@v4</span>
      <span style="color: rgb(129, 162, 190); font-weight: 400;">-</span> <span style="color: rgb(197, 200, 198); font-weight: 400;">name:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">Set</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">github</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">user</span>
        <span style="color: rgb(197, 200, 198); font-weight: 400;">run:</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">git</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">config</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">--global</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">user.email</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">"test@example.com"</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">&amp;&amp;</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">git</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">config</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">--global</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">user.name</span> <span style="color: rgb(181, 189, 104); font-weight: 400;">"CI/CD"</span>
      <span style="color: rgb(112, 120, 128); font-weight: 400;"># ...</span></pre>
              </li>
              <li>
                Installer des d√©pendances : <code>npm ci</code> ("ci" fait un
                "clean install")
              </li>
              <li>
                D√©finir l'utilisateur git :
                <code>git config --global user.email / user.name</code>.
                <p>Note : Il n'est pas n√©cessaire de mettre une vraie adresse
                    e-mail et nom d'utilisateur</p>
              </li>
              <li>
                Mettre √† jour la version : <code>npm run release --ci </code>
              </li>
            </ol>
            <div class="note-information">
              <p>
                On veut que cette Action se lance manuellement, ainsi
                l'√©v√®nement (cl√© "on") devra √™tre "workflow_dispatch". Voir
                image ci-dessous pour lancer manuellement votre Action.
              </p>
              <figure>
                <img src="actions-1.jpg" alt="" />
              </figure>
              <ul>
                <li>
                  <a
                    href="https://docs.github.com/fr/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows"
                    target="_blank"
                    rel="noopener noreferrer"
                    >Voir liste des √©v√®nements - Ouverture dans un nouvel
                    onglet</a
                  >
                </li>
              </ul>
            </div>
            <p class="note-attention">
              Il est possible que la t√¢che de release soit bloqu√©e. Pour r√©gler
              ce probl√®me, allez dans les "Settings" de votre d√©p√¥t puis dans la
              partie Actions > General > Workflow permissions, s√©lectionnez
              "Read and write permissions" et sauvegardez.
            </p>
          </li>
        </ol>
      </details>
      <details class="consignes-conteneur">
        <summary>
          <h1 class="h1">Partie 3 (cliquer pour afficher / cacher)</h1>
        </summary>
        <div class="note-information">
          <p>
            Pour cette derni√®re partie, vous allez d√©ployer, gr√¢ce aux actions,
            le build du projet contenu dans le dossier "partie-3", c'est un site
            web en html utilisant vite pour tailwind ou encore la gestion des
            modules javascript.
          </p>
          <p>
            A noter que pour d√©ployer via la CI/CD, il vous faut un h√©bergeur
            qui vous permet de vous connecter en SSH. Si
            vous n'en avez pas, sachez qu'Alwaysdata vous le permet.
          </p>
          <p>
            Le plus simple est d'utiliser la commande rsync pour copier en ssh, le contenu de votre serveur de CI/CD vers le serveur de production.
          </p>
          <ul>
            <li>
                <a href="https://doc.ubuntu-fr.org/rsync" target="_blank" rel="noopener noreferrer">Voir documentation de la commande rsync - ouverture dans un nouvel onglet</a>
            </li>
          </ul>
          <p>
            N'oubliez pas que sur un serveur, la racine est le dossier www, n'allez pas tout copier n'importe o√π.
          </p>
        </div>
        <p class="note-attention">L'utilisation de la commande rsync fonctionne, mais elle n'est pas des plus optimale. Dans une pipeline CI/CD "parfaite", on g√©n√®rera plut√¥t une image Docker qui sera upload√©e sur le serveur de production.</p>
        <ol class="liste-consignes">
          <li>
            Cr√©ez un nouveau d√©p√¥t ou remplacez le contenu de votre d√©p√¥t
            existant avec le contenu du dossier "partie-3"
          </li>
          <li>
            D√©finissez une CI/CD permettant les actions suivantes :
            <ul>
              <li>Lint le code javascript</li>
              <li>Ex√©cute les tests unitaires</li>
              <li>Ex√©cute les tests e2e
                <p class="note-information">Il faut ex√©cuter l'outil de e2e en mode CI. <a href="https://playwright.dev/docs/ci-intro" target="_blank">Vous trouverez plus d'informations sur le site de playwright</a></p>
              </li>
              <li>Build le projet</li>
              <li>
                D√©ploie le tout sur votre serveur
                <div class="note-information">
                  <p>Comme dit plus haut, vous allez devoir utiliser la commande <code>rsync</code>. Elle poss√®de l'avantage de ne transf√©rer que les fichiers qui ont √©t√© modifi√©s ce qui permet d'√©conomiser la bande passante.</p>
                  <p>Toutefois avant d'utiliser la commande, il faut imp√©rativement que votre acc√®s soit autoris√© sur le serveur de production. La m√©thode la plus ais√©e est d'autoriser votre cl√© ssh sur le serveur de production, ceci se fait via la commande <code>ssh-copy-id</code>, elle n'est √† faire qu'une seule fois, elle va ajouter vos clefs publiques (extension .pub) dans le registre "authorized_keys" pour ainsi vous permettre de faire un <code>rsync</code> en ssh sans entrer le mot de passe √† chaque fois. </p>
                  <p class="texte-gras">Ajoutez sa cl√© ssh √† un serveur (√† faire dans le terminal)</p>
                  <ol>
                    <li><code>ssh-copy-id user@server</code> 
                    <p class="note-attention">ssh-copy-id copie <span class="texte-gras">toutes</span> vos clefs publiques, si vous souhaitez pr√©ciser quelles cl√©s vous souhaitez copier, il faut passer le param√®tre -i suivi du nom de la cl√© publique (extension .pub)</p>
                    </li>
                    <li>Entrez le mot de passe ssh du serveur qui doit vous autoriser</li>
                    <li>Et voil√†</li>
                  </ol>
                  <p class="texte-gras">Effectuer un rsync en ssh (√† faire dans votre fichier yml)</p>
                  <ol>
                    <li>
                      <p>Ajoutez sa cl√© priv√©e dans le conteneur Docker</p>
                      <code>echo "ssh_key" > __ssh_key_path__ && chmod 400 __ssh_key_path__</code>
                    </li>
                    <li>
                      <p>D√©placez le contenu du dossier vers un serveur</p>
                      <code>rsync -Pavz -e "ssh -i __ssh_key_path__  -o StrictHostKeyChecking=no" source/ user@server:destination</code>
                      <div class="note-information">
                        <p><code>rsync</code> permet √©galement de synchroniser un seul fichier ou encore exclure des dossiers.</p>
                        <ul>
                          <li>
                            <a href="https://doc.ubuntu-fr.org/rsync" target="_blank" rel="noopener noreferrer">Voir documentation de la commande rsync - ouverture dans un nouvel onglet</a>
                          </li>
                        </ul>
                      </div>
                    </li>
                  </ol>
                  <div class="note-attention">
                    <p>Pour des questions de s√©curit√©, les param√®tres suivants doivent √™tre mis en secret. Menu Settings > Secrets and variables > Actions > Repository secrets sur Github</p>
                    <ul>
                      <li>user</li>
                      <li>server</li>
                      <li>ssh_key</li>
                    </ul>
                  </div>
                </div>
              </li>
            </ul>
            <div class="note-information">
                <p>Au lieu d'utiliser l'image ubuntu-latest, vous avez √©galement une image de node qui est propos√© par GitHub.</p>
                <ul>
                    <li>
                        <a href="https://github.com/actions/setup-node" target="_blank" rel="noopener noreferrer">En savoir plus sur l'image node de GitHub Actions</a>
                    </li>
                </ul>
            </div>
            <div class="note-information">
                <p>Cette partie contient beaucoup de lignes de commandes, si elles vous sont √©trang√®res, vous avez le site explainshell qui vous explique en d√©tails les commandes.</p>
                <ul>
                    <li>
                        <a href="https://explainshell.com/" target="_blank" rel="noopener noreferrer">Acc√©der √† explainshell</a>
                    </li>
                </ul>
            </div>
            <div class="note-information">
                <p>Votre CI/CD contient beaucoup d'actions. Rappelez-vous que les jobs de build et de d√©loiement sont interd√©pendantes et qu'il faut que les autres jobs doivent √™tre effectu√©es avant.</p>
                <ul>
                    <li>
                        <a href="https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions#jobsjob_idneeds" target="_blank" rel="noopener noreferrer">Voir documentation sur l'interd√©pendance des jobs</a>
                    </li>
                </ul>
            </div>
          </li>
        </ol>
      </details>
      <details class="consignes-conteneur">
        <summary>
          <h1 class="h1">Pour aller plus loin (cliquer pour afficher / cacher)</h1>
        </summary>
        <ol class="liste-consignes">
          <li>Ajouter le module release-it (utilis√© dans la partie 2) dans la CI/CD du projet de la partie 3</li>
      </details>
    </header>
  </body>
</html>
